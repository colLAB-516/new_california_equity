---
title: "California Climate Investments Analysis"
output: html_document
---

# Overview

This document analyzes the relationship between multi-agency collaboration and climate/equity outcomes using hierarchical regression, time-series panel analysis, and spatial matching.

## 1. Hierarchical Regression

```{r}
# Hierarchical Regression in R with Visualizations
library(dplyr)
library(ggplot2)

df <- read.csv("cci_programs_data_reduced.csv", stringsAsFactors=FALSE)
df <- subset(df, !grepl("Semi|Mid-Year", Reporting.Cycle.Name))

df$Total.Program.GGRFFunding <- as.numeric(df$Total.Program.GGRFFunding)
df$Total.Project.GHGReductions <- as.numeric(df$Total.Project.GHGReductions)
df$Total.GGRFDisadvantaged.Community.Funding <- as.numeric(df$Total.GGRFDisadvantaged.Community.Funding)

df$cost_per_ton <- df$Total.Program.GGRFFunding / df$Total.Project.GHGReductions
df$cost_per_ton[df$Total.Project.GHGReductions == 0] <- NA
df$share_DAC <- df$Total.GGRFDisadvantaged.Community.Funding / df$Total.Program.GGRFFunding

project_counties <- df %>% group_by(Project.ID.Number) %>% summarize(n_partners = n_distinct(County))
df <- df %>% left_join(project_counties, by="Project.ID.Number")
df$multi_county <- ifelse(df$n_partners > 1, 1, 0)
df$log_funding <- log1p(df$Total.Program.GGRFFunding)

south_counties <- c("Los Angeles","Orange","San Diego","Riverside","San Bernardino","Imperial","Ventura")
df$Region_South <- ifelse(df$County %in% south_counties, 1, 0)

model3 <- lm(cost_per_ton ~ log_funding + factor(Agency.Name) + factor(County) + n_partners * Region_South, data=df)
summary(model3)

# Visualization
ggplot(df, aes(x=n_partners, y=cost_per_ton)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm") +
  facet_wrap(~Region_South) +
  theme_minimal() +
  ggtitle("Cost per Ton vs. Number of Partners by Region")

```

## 2. Time-Series Panel Regression

```{r}
# Time-Series Analysis in R with Visuals
library(dplyr)
library(ggplot2)

df <- read.csv("cci_programs_data_reduced.csv", stringsAsFactors=FALSE)
df$Year <- as.integer(df$Reporting.Cycle.Name)
df$post_2020 <- ifelse(df$Year >= 2020, 1, 0)

df$Total.Program.GGRFFunding <- as.numeric(df$Total.Program.GGRFFunding)
df$Total.Project.GHGReductions <- as.numeric(df$Total.Project.GHGReductions)
df$Total.GGRFDisadvantaged.Community.Funding <- as.numeric(df$Total.GGRFDisadvantaged.Community.Funding)

df$cost_per_ton <- df$Total.Program.GGRFFunding / df$Total.Project.GHGReductions
df$share_DAC <- df$Total.GGRFDisadvantaged.Community.Funding / df$Total.Program.GGRFFunding
df$log_funding <- log1p(df$Total.Program.GGRFFunding)

model_panel <- lm(cost_per_ton ~ post_2020 + log_funding + factor(Agency.Name) + factor(Year), data=df)
summary(model_panel)

annual_stats <- df %>% group_by(Year) %>%
  summarize(
    avg_funding = mean(Total.Program.GGRFFunding, na.rm=TRUE),
    median_cost_per_ton = median(cost_per_ton, na.rm=TRUE),
    avg_share_DAC = mean(share_DAC, na.rm=TRUE)
  )

ggplot(annual_stats, aes(x=Year, y=avg_funding)) +
  geom_line() + geom_point() +
  geom_vline(xintercept=2020, linetype="dashed", color="red") +
  ggtitle("Average Project Funding by Year") + ylab("Avg Funding ($)")

ggplot(annual_stats, aes(x=Year, y=median_cost_per_ton)) +
  geom_line(color="darkgreen") + geom_point() +
  geom_vline(xintercept=2020, linetype="dashed", color="red") +
  ggtitle("Median Cost per Ton by Year") + ylab("Median $/Ton")

ggplot(annual_stats, aes(x=Year, y=avg_share_DAC)) +
  geom_line(color="purple") + geom_point() +
  geom_vline(xintercept=2020, linetype="dashed", color="red") +
  ggtitle("Average DAC Share by Year") + ylab("Share of Funding to DAC")

```

## 3. Spatial Analysis and Propensity Score Matching

```{r}
# Spatial Analysis & PSM in R with Visuals
library(dplyr)
library(MatchIt)
library(ggplot2)

df <- read.csv("cci_programs_data_reduced.csv", stringsAsFactors=FALSE)

df$Total.Program.GGRFFunding <- as.numeric(df$Total.Program.GGRFFunding)
df$Total.Project.GHGReductions <- as.numeric(df$Total.Project.GHGReductions)
df$Total.GGRFDisadvantaged.Community.Funding <- as.numeric(df$Total.GGRFDisadvantaged.Community.Funding)

df$cost_per_ton <- df$Total.Program.GGRFFunding / df$Total.Project.GHGReductions
df$share_DAC <- df$Total.GGRFDisadvantaged.Community.Funding / df$Total.Program.GGRFFunding
df$log_funding <- log1p(df$Total.Program.GGRFFunding)

project_df <- df %>% group_by(Project.ID.Number) %>% summarize(
  log_funding = first(log_funding),
  Agency.Name = first(Agency.Name),
  County = first(County),
  cost_per_ton = first(cost_per_ton),
  share_DAC = first(share_DAC),
  n_partners = n_distinct(County)
)

project_df$high_collab <- ifelse(project_df$n_partners > 5, 1, 0)
south_counties <- c("Los Angeles","Orange","San Diego","Riverside","San Bernardino","Imperial","Ventura")
project_df$Region_South <- ifelse(project_df$County %in% south_counties, 1, 0)

psm_model <- matchit(high_collab ~ log_funding + Agency.Name + Region_South, data=project_df, method="nearest")
matched <- match.data(psm_model)

# Compare outcomes
treated <- matched[matched$high_collab == 1,]
control <- matched[matched$high_collab == 0,]

t.test(treated$cost_per_ton, control$cost_per_ton)
t.test(treated$share_DAC, control$share_DAC)

# Visuals
ggplot(matched, aes(x=factor(high_collab), y=cost_per_ton)) +
  geom_boxplot() +
  ggtitle("Cost per Ton by Collaboration Intensity") +
  xlab("High Collaboration (1 = Yes)") + ylab("Cost per Ton")

ggplot(matched, aes(x=factor(high_collab), y=share_DAC)) +
  geom_boxplot() +
  ggtitle("Share of DAC by Collaboration Intensity") +
  xlab("High Collaboration (1 = Yes)") + ylab("DAC Share")

```
